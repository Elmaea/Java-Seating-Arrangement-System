<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seating Plan - Exam Seating Management</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="seating-outer">
        <div class="seating-header-row">
            <div class="seating-header-left">
                <a href="/upload.html" class="back-btn">Back</a>
            </div>
            <div class="seating-header-center">
                <h1 class="seating-title">Seating Plan</h1>
            </div>
            <div class="seating-header-right">
                <button id="exportBtn" class="export-btn">Export Excel</button>
            </div>
        </div>

        <div class="seating-rooms" id="seatingRooms">
            <div class="seating-placeholder">Loading seating arrangement...</div>
        </div>
    </div>

  <script>
    const BACKEND_URL = 'http://localhost:8080';
    let allSeatingData = null;

    // Fetch seating plan on page load
    window.onload = async () => {
        await fetchSeatingPlan();
        setupSearch();
    };

    async function fetchSeatingPlan() {
        try {
            const res = await fetch(`${BACKEND_URL}/api/seating`);
            if (!res.ok) throw new Error('Failed to fetch seating plan');

            const seating = await res.json();
            allSeatingData = seating; // Store for search functionality
            renderSeatingPlan(seating);
        } catch (error) {
            document.getElementById('seatingRooms').innerHTML = 
                '<div class="seating-placeholder">No seating plan available</div>';
            console.error('Error:', error);
        }
    }

    function renderSeatingPlan(seating) {
        const container = document.getElementById('seatingRooms');
        container.innerHTML = '';

        let roomTitle = '';
        let gridRows = [];
        
        seating.forEach((line, idx) => {
            if (line.startsWith('Room:')) {
                if (roomTitle && gridRows.length) {
                    container.appendChild(renderRoom(roomTitle, gridRows));
                }
                roomTitle = line;
                gridRows = [];
            } else if (line.trim() === '') {
                if (roomTitle && gridRows.length) {
                    container.appendChild(renderRoom(roomTitle, gridRows));
                }
                roomTitle = '';
                gridRows = [];
            } else {
                gridRows.push(line);
            }
        });

        if (roomTitle && gridRows.length) {
            container.appendChild(renderRoom(roomTitle, gridRows));
        }
    }

    function renderRoom(title, rows) {
        const roomDiv = document.createElement('div');
        roomDiv.className = 'room-block';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'room-title';
        titleDiv.textContent = title;
        roomDiv.appendChild(titleDiv);

        const gridDiv = document.createElement('div');
        gridDiv.className = 'room-grid';
        const grid = rows.map(r => r.split(' | '));
        
        grid.forEach(rowArr => {
            rowArr.forEach(cell => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'seat-cell';
                cellDiv.textContent = cell === '-' ? '' : cell;
                cellDiv.setAttribute('data-content', cell); // For search functionality
                gridDiv.appendChild(cellDiv);
            });
        });

        if (grid.length > 0) {
            gridDiv.style.gridTemplateRows = `repeat(${grid.length}, 1fr)`;
            gridDiv.style.gridTemplateColumns = `repeat(${grid[0].length}, 1fr)`;
        }
        
        roomDiv.appendChild(gridDiv);
        return roomDiv;
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!searchTerm) {
                    renderSeatingPlan(allSeatingData);
                    return;
                }

                const seats = document.querySelectorAll('.seat-cell');
                seats.forEach(seat => {
                    const content = seat.getAttribute('data-content').toLowerCase();
                    if (content.includes(searchTerm)) {
                        seat.style.background = '#ffeb3b';
                    } else {
                        seat.style.background = '';
                    }
                });
            }, 300);
        });
    }

    // Export seating plan as Excel
    document.getElementById('exportBtn').onclick = async () => {
        try {
            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.textContent = 'Exporting...';

            const res = await fetch(`${BACKEND_URL}/api/export-excel`);
            if (!res.ok) throw new Error('Failed to export seating plan');

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'SeatingPlan.xlsx');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            alert('Error exporting Excel file: ' + error.message);
        } finally {
            const btn = document.getElementById('exportBtn');
            btn.disabled = false;
            btn.textContent = 'Export Excel';
        }
    };
  </script>
</body>
</html>
