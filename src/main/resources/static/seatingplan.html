<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seating Plan</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Seating Plan</h1>
  <div class="seating-rooms" id="seatingRooms">Loading...</div>
  <button id="exportBtn">Export CSV</button>

  <script>
    const BACKEND_URL = 'http://localhost:8080';

    // Fetch seating plan on page load
    window.onload = async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/api/seating`);
        if (!res.ok) throw new Error('Failed to fetch seating plan');

        const seating = await res.json();
        const container = document.getElementById('seatingRooms');
        container.innerHTML = '';

        let roomTitle = '';
        let gridRows = [];
        seating.forEach((line, idx) => {
          if (line.startsWith('Room:')) {
            // Render previous room if exists
            if (roomTitle && gridRows.length) {
              container.appendChild(renderRoom(roomTitle, gridRows));
            }
            roomTitle = line;
            gridRows = [];
          } else if (line.trim() === '') {
            // End of room
            if (roomTitle && gridRows.length) {
              container.appendChild(renderRoom(roomTitle, gridRows));
            }
            roomTitle = '';
            gridRows = [];
          } else {
            gridRows.push(line);
          }
        });
        // Render last room
        if (roomTitle && gridRows.length) {
          container.appendChild(renderRoom(roomTitle, gridRows));
        }
      } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('seatingRooms').innerHTML = 'No seating plan available.';
      }
    };

    function renderRoom(title, rows) {
      const roomDiv = document.createElement('div');
      roomDiv.className = 'room-block';
      const titleDiv = document.createElement('div');
      titleDiv.className = 'room-title';
      titleDiv.textContent = title;
      roomDiv.appendChild(titleDiv);

      const gridDiv = document.createElement('div');
      gridDiv.className = 'room-grid';
      const grid = rows.map(r => r.split(' | '));
      grid.forEach(rowArr => {
        rowArr.forEach(cell => {
          const cellDiv = document.createElement('div');
          cellDiv.className = 'seat-cell';
          cellDiv.textContent = cell === '-' ? '' : cell;
          gridDiv.appendChild(cellDiv);
        });
      });
      // Set grid style
      if (grid.length > 0) {
        gridDiv.style.display = 'grid';
        gridDiv.style.gridTemplateRows = `repeat(${grid.length}, 1fr)`;
        gridDiv.style.gridTemplateColumns = `repeat(${grid[0].length}, 1fr)`;
      }
      roomDiv.appendChild(gridDiv);
      return roomDiv;
    }

    // Export seating plan as CSV
    document.getElementById('exportBtn').onclick = async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/api/seating`);
        if (!res.ok) throw new Error('Failed to fetch seating plan');

        const data = await res.json();
        const csvContent = "data:text/csv;charset=utf-8," + data.join("\n");
        const encodedUri = encodeURI(csvContent);

        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "SeatingPlan.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        alert('Error exporting CSV: ' + error.message);
      }
    };
  </script>
</body>
</html>
